name: Documentation Generation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'docs/**'
      - 'README.md'
      - 'pyproject.toml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'docs/**'
      - 'README.md'
      - 'pyproject.toml'

jobs:
  docs:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install mkdocs-material[imaging] mkdocstrings[python] mike
        pip install -e .

    - name: Generate API documentation
      run: |
        # Create API docs from source code
        mkdir -p docs/api/reference
        python -c "
        import os
        import subprocess
        from pathlib import Path
        
        # Create API documentation using pydoc
        src_dir = 'src/qwen3_vl'
        api_dir = 'docs/api/reference'
        
        # Create module index
        with open(f'{api_dir}/index.md', 'w') as f:
            f.write('# API Reference\\n\\n')
            f.write('Browse the API documentation for different modules:\\n\\n')
        
        # Walk through all modules and create documentation
        for root, dirs, files in os.walk(src_dir):
            for file in files:
                if file.endswith('.py') and not file.startswith('__'):
                    module_path = os.path.join(root, file)
                    rel_path = os.path.relpath(module_path, src_dir)
                    module_parts = rel_path.replace('/', '.').replace('\\\\', '.').replace('.py', '').split('.')
                    
                    # Skip if '__init__' in module_parts
                    if '__init__' in module_parts:
                        continue
                        
                    module_name = '.'.join([src_dir.replace('/', '.')] + [part for part in module_parts if part])
                    
                    # Create directory for module documentation
                    doc_dir = os.path.join(api_dir, *module_parts[:-1])
                    os.makedirs(doc_dir, exist_ok=True)
                    
                    # Create documentation file
                    doc_file = os.path.join(doc_dir, f'{module_parts[-1]}.md')
                    with open(doc_file, 'w') as f:
                        f.write(f'# `{module_name}`\\n\\n')
                        f.write(f'::: {module_name}\\n')
                    
                    # Update index
                    with open(f'{api_dir}/index.md', 'a') as f:
                        module_link = '/'.join(module_parts) + '/'
                        f.write(f'- [{module_name}]({module_link})\\n')
        "

    - name: Build documentation
      run: |
        mkdocs build --site-dir site

    - name: Deploy documentation to GitHub Pages
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./site
        force_orphan: true

    - name: Upload documentation as artifact
      uses: actions/upload-artifact@v4
      with:
        name: documentation-site
        path: site/
        retention-days: 30